{"id":29319,"name":"testing-ActiveCampaignValidateFinal-Setup","userId":27893,"accountId":24428,"createdDate":"2019-09-03T05:34:56Z","steps":[{"id":264161,"onSuccess":["SendFinalCard"],"onFailure":[],"name":"ChargebeeGetTpIntegConf","type":"formula","properties":{"args":"${steps.InputParams.config}","formulaId":"31257"}},{"id":214332,"onSuccess":["SendFinalCard"],"onFailure":[],"name":"getConfig","type":"httpRequest","properties":{"headers":"${steps.InputParams.config.auth}","query":"${steps.InputParams.config.query}","method":"GET","url":"${steps.InputParams.config.url}"}},{"id":214333,"onSuccess":["ChargebeeGetTpIntegConf"],"onFailure":[],"name":"InputParams","type":"script","properties":{"body":"let apiKey = trigger.args.request.query['apiKey'];\nlet siteName = trigger.args.request.query['siteName'];\nlet type = trigger.args.request.query['type'];\nlet siteDomain = trigger.args.request.query['siteDomain'];\nlet password=\"\";\n\nlet params={\n  config :{\n      // url: \"https://\"+siteName+\".\"+siteDomain+\"/api/v2/third_party_configurations\",\n      url: \"https://\" + siteName + \".integrations.\" + siteDomain + \"/api/third_party_configurations/tpmeta\",\n      headers:{\n        Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password),\n        api_key: apiKey\n      },\n      query:{\n        integration_name: type\n      },\n      apiKey: apiKey,\n      siteName: siteName,\n      siteDomain: siteDomain,\n      type: type\n  }};\n  done(params);"}},{"id":264162,"onSuccess":["SendFinalCard"],"onFailure":[],"name":"isTpConfigFetched","type":"filter","properties":{"body":"if(steps.ChargebeeGetTpIntegConf.cb_status === \"success\"){\n  done(true);\n}\n\ndone(false);"}},{"id":264163,"onSuccess":[],"onFailure":[],"name":"SendErrorCard","type":"script","properties":{"body":"let card = {\n    \"cards\": [{\n        \"id\": \"check2\",\n        \"card\": {\n                \"type\": \"ACTION\",\n                \"heading\": \"ERROR\",\n                \"icon\": \"ERROR\",\n                \"subHeading\": \"An issue was encountered due to which the validtion did not succeed. Please try after sometime.\"\n            }\n    }],\n    \"proceed\": {\n    \"buttonLook\": \"FILLED\",\n    \"display\": \"Proceed\",\n    \"icon\": \"ARROW\",\n    \"id\": \"proceed\",\n    \"request\": {\n      \"apiEndPoint\": {\n        \"apiUrl\": \"https://staging.cloud-elements.com/elements/api-v2/validate/proceed\",\n        \"headers\": {\n          \"Elements-Formula-Instance-Id\": \"376920\"\n        },\n        \"type\": \"GET\"\n      },\n      \"type\": \"ON_CLICK_SEND_INPUT\"\n    },\n    \"type\": \"DIRECT_LINK\"\n  },\n  \"retry\": {\n    \"buttonLook\": \"FILLED\",\n    \"display\": \"Retry Data Validation\",\n    \"icon\": \"ARROW\",\n    \"id\": \"retry\",\n    \"request\": {\n      \"apiEndPoint\": {\n        \"apiUrl\": \"https://staging.cloud-elements.com/elements/api-v2/validate\",\n        \"headers\": {\n          \"Elements-Formula-Instance-Id\": info.formulaInstanceId\n        },\n        \"input\": {\n          \"retry\": \"true\",\n          \"type\": \"activecampaign\"\n        },\n        \"type\": \"GET\"\n      },\n      \"type\": \"ON_CLICK_DEFAULT_ACTION\"\n    },\n    \"type\": \"DIRECT_LINK\"\n  }\n};\n\ndone({\n  statusCode: 200,\n  result: card\n});"}},{"id":214334,"onSuccess":[],"onFailure":[],"name":"SendFinalCard","type":"script","properties":{"body":"let formula= steps.ChargebeeGetTpIntegConf.data.config_json.cloudElements.formula;\n\nlet card = {\n   \"cards\":[\n      {\n         \"id\" : \"check2\",\n         \"card\": {\n            \"type\" : \"ACTION\",\n            \"heading\" : \"You've ignored errors found during data validation.\",\n            \"icon\" : \"WARNING\",\n         },\n         \"isCardDone\":\"true\"\n      }\n   ],\n   \"proceed\" : {\n        \"id\": \"proceed_ignorecard\",\n        \"display\": \"Proceed\",\n        \"icon\": \"ARROW\",\n        \"buttonLook\": \"FILLED\",\n        \"type\": \"DIRECT_LINK\",\n        \"request\": {\n            \"type\": \"ON_CLICK_SEND_INPUT\",\n            \"apiEndPoint\": {\n                \"apiUrl\": \"https://staging.cloud-elements.com/elements/api-v2/validate/proceed\",\n                \"type\": \"GET\",\n                \"headers\": {\n                    \"Elements-Formula-Instance-Id\": formula.activeCampaignValidateProceedSetup.instance\n                }\n            }\n        }\n    },\n   \"retry\": {\n    \"buttonLook\": \"FILLED\",\n    \"display\": \"Retry Data Validation\",\n    \"icon\": \"ARROW\",\n    \"id\": \"retry_ignorecard\",\n    \"request\": {\n      \"apiEndPoint\": {\n        \"apiUrl\": \"https://staging.cloud-elements.com/elements/api-v2/validate\",\n        \"headers\": {\n          \"Elements-Formula-Instance-Id\": formula.activeCampaignValidateSetup.instance\n        },\n        \"input\": {\n          \"retry\": \"true\",\n          \"siteDomain\": \"predev3.in\",\n          \"type\": \"activecampaign\"\n        },\n        \"type\": \"GET\"\n      },\n      \"type\": \"ON_CLICK_DEFAULT_ACTION\"\n    },\n    \"type\": \"DIRECT_LINK\"\n  }\n};\n\ndone({\n statusCode: 200,\n result: card\n});\n"}}],"triggers":[{"id":25954,"onSuccess":["InputParams"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"subFormulas":[{"id":31257,"name":"ChargebeeGet","userId":27893,"accountId":24428,"createdDate":"2019-11-12T11:30:28Z","steps":[{"id":245638,"onSuccess":["ChargebeeGetCBDelay2"],"onFailure":["ChargebeeGetResult"],"name":"ChargebeeGetCallAgainCB","type":"filter","properties":{"body":"//done(false); //Since delay causing 30 second limit issues\n\n\nif(steps.ChargebeeGetInputParams.intervel.length > 0 && steps.ChargebeeGetInputParams.retryCode[steps.ChargebeeGetGetCBData.response.code] !== undefined) {\n  steps.ChargebeeGetInputParams.delay.query.delay = steps.ChargebeeGetInputParams.intervel.pop();\n  done(true);\n}else {\n  done(false);\n}\n"}},{"id":245636,"onSuccess":["ChargebeeGetCBDelay"],"onFailure":["ChargebeeGetResult2"],"name":"ChargebeeGetCallAgainHttp","type":"filter","properties":{"body":"done(false); //Since delay causing 30 second limit issues\n\nif(steps.ChargebeeGetInputParams.intervel.length > 0 && steps.ChargebeeGetInputParams.retryCode[steps.ChargebeeGetGetHttpData.response.code] !== undefined) {\n  steps.ChargebeeGetInputParams.delay.query.delay = steps.ChargebeeGetInputParams.intervel.pop();\n  done(true);\n}else {\n  done(false);\n}\n"}},{"id":245637,"onSuccess":["ChargebeeGetGetHttpData"],"onFailure":[],"name":"ChargebeeGetCBDelay","type":"httpRequest","properties":{"query":"${steps.ChargebeeGetInputParams.delay.query}","headers":"${steps.ChargebeeGetInputParams.delay.headers}","method":"GET","url":"${steps.ChargebeeGetInputParams.delay.url}"}},{"id":245639,"onSuccess":["ChargebeeGetGetCBData"],"onFailure":[],"name":"ChargebeeGetCBDelay2","type":"httpRequest","properties":{"headers":"${steps.ChargebeeGetInputParams.delay.headers}","query":"${steps.ChargebeeGetInputParams.delay.query}","method":"GET","url":"${steps.ChargebeeGetInputParams.delay.url}"}},{"id":244768,"onSuccess":[],"onFailure":[],"name":"ChargebeeGetError","type":"script","properties":{"body":"done({\n  cb_status:\"failure\",\n  cb_error_code:\"formula_invalid_url\"\n});"}},{"id":244769,"onSuccess":["ChargebeeGetCallAgainCB"],"onFailure":["ChargebeeGetCallAgainCB"],"name":"ChargebeeGetGetCBData","type":"elementRequest","properties":{"headers":"${steps.ChargebeeGetInputParams.headers}","query":"${steps.ChargebeeGetInputParams.query}","api":"${steps.ChargebeeGetInputParams.url}","method":"GET","acceptableStatusCodes":"200-600","body":"","elementInstanceId":"${config.chargebee}"}},{"id":244774,"onSuccess":["ChargebeeGetCallAgainHttp"],"onFailure":["ChargebeeGetCallAgainHttp"],"name":"ChargebeeGetGetHttpData","type":"httpRequest","properties":{"query":"${steps.ChargebeeGetInputParams.query}","headers":"${steps.ChargebeeGetInputParams.headers}","method":"GET","acceptableStatusCodes":"200-600","url":"${steps.ChargebeeGetInputParams.url}","body":""}},{"id":244764,"onSuccess":["ChargebeeGetIsValidUrl"],"onFailure":[],"name":"ChargebeeGetInputParams","type":"script","properties":{"body":"let url = trigger.args.url;\nlet query = trigger.args.query;\nlet apiKey = trigger.args.apiKey;\nlet headers = trigger.args.headers;\nlet siteDomain = trigger.args.siteDomain;\nlet siteName = trigger.args.siteName;\nlet type = trigger.args.type;\n\n\nlet intervel = [];\nintervel.push(5000);\nintervel.push(4000);\nintervel.push(3000);\nintervel.push(2000);\nintervel.push(1000);\n\nif (query === undefined) {\n    query = {};\n}\nif (headers === undefined) {\n    headers = {};\n}\ndone({\n    url: url,\n    query: query,\n    //intervel:[5000,10000,20000,40000,80000],\n    intervel: intervel,\n    retryCode: {\n        503: true,\n        429: true,\n        502: true,\n        403: true,\n        400: true,\n    },\n    hardStop: {\n        503: true,\n        429: true,\n        502: true,\n        403: true,\n        400: true,\n        500:true,\n        401:true\n    },\n    headers: headers,\n    delay: {\n        url: \"https://\" + siteName + \".integrations.\" + siteDomain + \"/api/ipaasdelay\",\n        query: {\n            delay: 2000\n        },\n        headers: {\n            \"api_key\": apiKey\n        }\n    }\n});"}},{"id":244771,"onSuccess":["ChargebeeGetGetHttpData"],"onFailure":["ChargebeeGetGetCBData"],"name":"ChargebeeGetIsHttp","type":"filter","properties":{"body":"done(steps.ChargebeeGetInputParams.url.startsWith(\"https://\"));"}},{"id":244767,"onSuccess":["ChargebeeGetIsHttp"],"onFailure":["ChargebeeGetError"],"name":"ChargebeeGetIsValidUrl","type":"filter","properties":{"body":"done(steps.ChargebeeGetInputParams.url !== undefined && steps.ChargebeeGetInputParams.url!== \"\");"}},{"id":244770,"onSuccess":[],"onFailure":[],"name":"ChargebeeGetResult","type":"script","properties":{"body":"if(steps.ChargebeeGetGetCBData.response.code < 300) {\n  done({\n    cb_status:\"success\",\n    cb_code: steps.ChargebeeGetGetCBData.response.code,\n    data:steps.ChargebeeGetGetCBData.response.body\n  });\n}else {\n  let cb_error_code = \"formula_default_error\";\n\n  let hardstop = steps.ChargebeeGetInputParams.hardStop[steps.ChargebeeGetGetCBData.response.code] !== undefined;\n  if(steps.ChargebeeGetGetCBData.response!== undefined && steps.ChargebeeGetGetCBData.response.body!== undefined && steps.ChargebeeGetGetCBData.response.body.error_code !== undefined) {\n    cb_error_code = steps.ChargebeeGetGetCBData.response.body.error_code;\n    let cbcode = steps.ChargebeeGetGetCBData.response.code || 404;\n  }\n  done({\n    cb_status:\"failure\",\n    cb_error_code:cb_error_code,\n    cb_code: cbcode,\n    cb_exit:hardstop\n  });\n}\n\n"}},{"id":244775,"onSuccess":[],"onFailure":[],"name":"ChargebeeGetResult2","type":"script","properties":{"body":"if(steps.ChargebeeGetGetHttpData.response.code <300) {\n  done({\n    cb_status:\"success\",\n    cb_code: steps.ChargebeeGetGetHttpData.response.code,\n    data:steps.ChargebeeGetGetHttpData.response.body\n  });\n}else {\n  let cb_error_code = \"formula_default_error\";\n\n  let hardstop = steps.ChargebeeGetInputParams.hardStop[steps.ChargebeeGetGetHttpData.response.code] !== undefined;\n  if(steps.ChargebeeGetGetHttpData.response.body!== undefined && steps.ChargebeeGetGetHttpData.response.body.error_code !== undefined) {\n    cb_error_code = steps.ChargebeeGetGetHttpData.response.body.error_code;\n  }\n  done({\n    cb_status:\"failure\",\n    cb_error_code:cb_error_code,\n    cb_exit:hardstop,\n    cb_code: steps.ChargebeeGetGetHttpData.response.code\n  });\n}\n\n"}}],"triggers":[{"id":27722,"onSuccess":["ChargebeeGetInputParams"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"engine":"v3","active":true,"debugLoggingEnabled":false,"singleThreaded":false,"configuration":[{"id":59935,"key":"chargebee","name":"chargebee","type":"elementInstance","required":true}]}],"method":"GET","uri":"/validate/final","engine":"v1","active":true,"debugLoggingEnabled":true,"singleThreaded":false,"api":"GET /validate/final","configuration":[]}