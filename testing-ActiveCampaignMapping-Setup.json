{"id":29310,"name":"testing-ActiveCampaignMapping-Setup","userId":27893,"accountId":24428,"createdDate":"2019-09-03T05:31:04Z","steps":[{"id":213947,"onSuccess":[],"onFailure":[],"name":"callback","type":"script","properties":{"body":"let card =steps.GetThirdPartyMapping.response.body.cardResult;\nlet cardStatus =steps.GetThirdPartyMapping.response.body.cardStatus;\nlet apiKey = steps.InputParams.mainTrigger.request.query['cb-api-key'];\nlet siteName = steps.InputParams.mainTrigger.request.query['cb-site-name'];\nlet type = steps.InputParams.mainTrigger.request.query['type'];\nlet siteDomain = steps.InputParams.mainTrigger.request.query['siteDomain'];\n\nlet formula= steps.ChargebeeGetTpIntegConf.data.config_json.cloudElements.formula;\n\nif(steps.InputParams.input.op===\"edit\"){\n  \n  card.dismissText=\"Dismiss\";\n  card.cards[0].showRetry=false;\n  \n  card.save={\n      \"id\":\"save\",\n      \"display\" : \"Save\",\n      \"type\" : \"DIRECT_LINK\",\n      \"buttonLook\":\"FILLED\"\n    \n    };\n  \n}\n\nelse{\n  if(cardStatus!==\"MAPPING-FAILED\"){\ncard.proceed = {\n      \"id\":\"proceed\",\n      \"display\" : \"Proceed\",\n      \"icon\" : \"ARROW\",\n      \"buttonLook\":\"FILLED\",\n      \"type\" : \"DIRECT_LINK\",\n      \"request\":{\n         \"type\":\"ON_CLICK_SEND_INPUT\",\n         \"apiEndPoint\":{\n            \"apiUrl\":\"https://staging.cloud-elements.com/elements/api-v2/mapping/proceed\",\n            \"type\":\"GET\",\n            \"headers\":{\n               \"Elements-Formula-Instance-Id\":formula.activeCampaignMappingProceedSetup.instance\n            },\n            \"input\":{\n               \"apiKey\":steps.InputParams.input.apiKey,\n               \"siteName\" :steps.InputParams.input.siteName,\n               \"type\":steps.InputParams.input.type,\n               \"siteDomain\":steps.InputParams.input.siteDomain\n            }\n         }\n      }\n    }\n  }else{\n    card.proceed = {\n      \"id\":\"proceed\",\n      \"display\" : \"Resolve\",\n      \"icon\" : \"ARROW\",\n      \"buttonLook\":\"FILLED\",\n      \"type\" : \"DIRECT_LINK\",\n   \n    }\n  }\n  \n    }//else end\n\ndone({\n  statusCode: 200,\n  result: card\n})"}},{"id":213948,"onSuccess":["ConfigParams"],"onFailure":[],"name":"ChargebeeConfigParams","type":"httpRequest","properties":{"method":"GET","url":"${steps.InputParams.input.config.url}","headers":"${steps.InputParams.input.config.auth}","query":"${steps.InputParams.input.config.query}"}},{"id":264164,"onSuccess":["IsTpIntegConfFetched"],"onFailure":[],"name":"ChargebeeGetTpIntegConf","type":"formula","properties":{"args":"${steps.InputParams.input}","formulaId":"31257"}},{"id":213949,"onSuccess":["GetThirdPartyMapping"],"onFailure":[],"name":"ConfigParams","type":"script","properties":{"body":"let apiKey = steps.InputParams.input.apiKey;\nlet siteName = steps.InputParams.input.siteName;\nlet type = steps.InputParams.input.type;\nlet siteDomain = steps.InputParams.input.siteDomain;\n\nlet configuration = {\n   mappingHeader :  {\n                        \"Elements-Formula-Instance-Id\": steps.ChargebeeGetTpIntegConf.data.config_json.cloudElements.formula.mapping.instance\n                    },\n    configJson : steps.ChargebeeGetTpIntegConf.data,\n    mappingInput:{},\n    body:{}\n}\nif(steps.ChargebeeGetTpIntegConf.data.config_json.cloudElements.formula.mapping.inputs !== undefined) {\n  configuration.mappingInput = steps.ChargebeeGetTpIntegConf.data.config_json.cloudElements.formula.mapping.inputs;\n}\n\n//\nconfiguration.mappingInput.ChargebeeConfigParams=JSON.stringify({\n  apiKey:apiKey,\n  siteName:siteName,\n  type:type,\n  siteDomain:siteDomain\n});\ndone(configuration);\n\n"}},{"id":213950,"onSuccess":["isListAvailable"],"onFailure":[],"name":"GetThirdPartyMapping","type":"request","properties":{"method":"GET","headers":"${steps.ConfigParams.mappingHeader}","api":"/${steps.InputParams.input.type}/mapping","query":"${steps.ConfigParams.mappingInput}"}},{"id":213951,"onSuccess":["ChargebeeGetTpIntegConf"],"onFailure":[],"name":"InputParams","type":"script","properties":{"body":"let apiKey = trigger.args.request.query['cb-api-key'];\nlet siteName = trigger.args.request.query['cb-site-name'];\nlet type = trigger.args.request.query['type'];\nlet siteDomain = trigger.args.request.query['cb-domain'];\nlet op = trigger.args.request.query['op'];\nlet password = \"\";\n\nlet mainTrigger = trigger.args;\n\nlet params = {\n  mainTrigger: mainTrigger,\n  input: {\n    apiKey: apiKey,\n    siteName: siteName,\n    siteDomain:siteDomain,\n    type: type,\n    op:op,\n      // url: \"https://\"+siteName+\".\"+siteDomain+\"/api/v2/third_party_configurations\",\n    url: \"https://\" + siteName + \".integrations.\" + siteDomain + \"/api/third_party_configurations/tpmeta\",\n    headers:{\n      Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password),\n      api_key: apiKey\n    },\n    query:{\n      integration_name: type\n    }\n  }\n};\n\ndone(params);"}},{"id":213952,"onSuccess":["Success"],"onFailure":["keyExpired"],"name":"isKeyExpired","type":"filter","properties":{"body":"let statusCode = steps.GetThirdPartyMapping.response.body.code;\n\n// let result=steps.GetThirdPartyMapping.response.body.cardStatus;\nif(statusCode === 403){\n  done(false);\n}\ndone(true);"}},{"id":213953,"onSuccess":["isKeyExpired"],"onFailure":["callback"],"name":"isListAvailable","type":"filter","properties":{"body":"let statusCode = steps.GetThirdPartyMapping.response.body.code;\n\n// let result=steps.GetThirdPartyMapping.response.body.cardStatus;\nif(statusCode === 404){\n  done(false);\n}\ndone(true);"}},{"id":264165,"onSuccess":["ConfigParams"],"onFailure":["SendErrorCard"],"name":"IsTpIntegConfFetched","type":"filter","properties":{"body":"if(steps.ChargebeeGetTpIntegConf.cb_status === \"success\"){\n  done(true);\n}\n\ndone(false);"}},{"id":213954,"onSuccess":[],"onFailure":[],"name":"keyExpired","type":"script","properties":{"body":"let card = steps.GetThirdPartyMapping.response.body.cardResult;\nlet cardStatus = steps.GetThirdPartyMapping.response.body.cardStatus;\nlet apiKey = steps.InputParams.mainTrigger.request.query['cb-api-key'];\nlet siteName = steps.InputParams.mainTrigger.request.query['cb-site-name'];\nlet type = steps.InputParams.mainTrigger.request.query['type'];\nlet siteDomain = steps.InputParams.mainTrigger.request.query['cb-domain'];\n\nlet formula = steps.ChargebeeGetTpIntegConf.data.config_json.cloudElements.formula;\n\nif (steps.InputParams.input.op === \"edit\") {\n\n  card.dismissText = \"Dismiss\";\n  card.cards[0].showRetry = true;\n\n  card.save = {\n    \"id\": \"save\",\n    \"display\": \"Save\",\n    \"type\": \"DIRECT_LINK\",\n    \"buttonLook\": \"FILLED\"\n\n  };\n}\nelse {\n  card.proceed = {\n\n    \"display\": \"Resolve\",\n    \"icon\": \"ARROW\",\n    \"id\": \"errors\",\n    \"type\": \"POP_UP\",\n    \"requestType\": \"authexpiry\",\n    \"popUp\": {\n      \"inputFields\": [\n        {\n          \"dispName\": \"Base Url\",\n          \"req\": \"true\",\n          \"type\": \"TEXT\",\n          \"id\": \"text\",\n          \"placeholder\": \"EG: ABC.ACTIVEHOSTED.COM \"\n        },\n        {\n          \"dispName\": \"API Secret\",\n          \"req\": \"true\",\n          \"type\": \"PASSWORD\",\n          \"id\": \"password\",\n          \"placeholder\": \"eg: 1233asfsdf23434343434\"\n        },\n        {\n          \"req\": \"true\",\n          \"type\": \"CHECKBOX\",\n          \"id\": \"checkbox1\",\n          \"desc\": \"I understand that, ActiveCampaign may store my customer and subscription data. (Please refer to ActiveCampaign's <a href='https://www.activecampaign.com/terms-of-service'>Terms of Service</a>, <a href='https://www.activecampaign.com/consent-policy'>Consent policy</a> and <a href='https://www.activecampaign.com/privacy-policy'>Privacy policy</a>).\"\n        }\n      ],\n      \"message\": {\n        \"message\": \"You can get your Base URL and API secret from ActiveCampaign by navigating to Settings > Developer\"\n      },\n      \"title\": \"Connect to ActiveCampaign\",\n      \"submitButton\": \"Connect\",\n      \"cancelButton\": \"Dismiss\",\n      \"description\": \"Specify your ActiveCampaign Base URL and API secret\",\n      \"advance\": \"true\",\n      \"type\": \"INPUT\",\n      \"apiEndPoint\": {\n        \"apiUrl\": \"https://staging.cloud-elements.com/elements/api-v2/create\",\n        \"type\": \"GET\",\n        \"headers\": {\n          \"Elements-Formula-Instance-Id\": formula.activeCampaignCreateSetup.instance\n        },\n        \"input\": {\n          \"type\": type,\n          \"siteDomain\": siteDomain,\n          \"formulaCreate\": formula.create.instance,\n          \"isReauthenticate\": true\n\n        }\n      }\n    }\n\n  };\n}\n\ndone({\n  statusCode: 200,\n  result: card\n})"}},{"id":213955,"onSuccess":[],"onFailure":[],"name":"SendErrorCard","type":"script","properties":{"body":"let card = {\n    \"cards\": [{\n        \"id\": \"check2\",\n        \"card\": {\n            \"type\": \"ACTION\",\n            \"heading\": \"ERROR\",\n            \"listContent\": [\n                \"An issue was encountered due to which the page loading did not succeed. Please try after sometime.\"\n            ],\n            \"icon\": \"ERROR\"\n          \n        }\n    }]\n}\n\n\nif (steps.InputParams.input.op === \"edit\") {\n\n  card.dismissText = \"Dismiss\";\n  card.cards[0].showRetry = true;\n\n  card.save = {\n    \"id\": \"save\",\n    \"display\": \"Save\",\n    \"type\": \"DIRECT_LINK\",\n    \"buttonLook\": \"FILLED\"\n  };\n}\n\ndone({\n  statusCode: 200,\n  result: card\n})"}},{"id":213956,"onSuccess":["SendErrorCard"],"onFailure":[],"name":"sendErrorMail","type":"httpRequest","properties":{"method":"POST","url":"${steps.InputParams.input.errorEmailEndpoint}","headers":"${steps.InputParams.input.authHeader}","query":"${steps.sendErrorMailParams.params}"}},{"id":213957,"onSuccess":["sendErrorMail"],"onFailure":["sendErrorMail"],"name":"sendErrorMailParams","type":"script","properties":{"body":"let payload = {\n  content : \"Integration Error, Formula-Instance-ID : \" + trigger.args.request.headers['elements-formula-instance-id'],\n  subject : \"Fatal Error Occurred during \" + steps.InputParams.input.type + \" Integration\",\n  to_address : steps.InputParams.input.errorEmailAddress,\n  api_key : steps.InputParams.input.apiKey\n}\n\n\nlet authHeader = {\n  Authorization: \"Basic \" + CE.b64(steps.InputParams.input.apiKey + \":\" + \"\")\n};\n\ndone({\n  params: payload,\n  authHeader: authHeader\n});"}},{"id":213958,"onSuccess":[],"onFailure":[],"name":"Success","type":"script","properties":{"body":"let card =steps.GetThirdPartyMapping.response.body.cardResult;\nlet cardStatus =steps.GetThirdPartyMapping.response.body.cardStatus;\nlet apiKey = steps.InputParams.mainTrigger.request.query['cb-api-key'];\nlet siteName = steps.InputParams.mainTrigger.request.query['cb-site-name'];\nlet type = steps.InputParams.mainTrigger.request.query['type'];\nlet siteDomain = steps.InputParams.mainTrigger.request.query['cb-domain'];\n\nlet formula= steps.ChargebeeGetTpIntegConf.data.config_json.cloudElements.formula;\n\nif(steps.InputParams.input.op===\"edit\"){\n  \n   card.dismissText=\"Dismiss\";\n  \n  card.save={\n      \"id\":\"save\",\n      \"display\" : \"Save\",\n      \"type\" : \"DIRECT_LINK\",\n      \"buttonLook\":\"FILLED\",\n      \"request\":{\n         \"type\":\"ON_CLICK_SEND_INPUT\",\n         \"apiEndPoint\": {\n                        \"apiUrl\": \"https://staging.cloud-elements.com/elements/api-v2/mapping/proceed\",\n                        \"type\": \"GET\",\n                        \"headers\": {\n                            \"Elements-Formula-Instance-Id\": formula.activeCampaignMappingProceedSetup.instance\n                        },\n                        \"input\":{\n                           \"apiKey\":steps.InputParams.input.apiKey,\n                           \"siteName\" :steps.InputParams.input.siteName,\n                           \"type\":steps.InputParams.input.type,\n                           \"siteDomain\":steps.InputParams.input.siteDomain\n                        }\n                    }\n      }\n    };\n}\n\nelse{\n  if(cardStatus!==\"MAPPING-FAILED\"){\ncard.proceed = {\n      \"id\":\"proceed\",\n      \"display\" : \"Proceed\",\n      \"icon\" : \"ARROW\",\n      \"buttonLook\":\"FILLED\",\n      \"type\" : \"DIRECT_LINK\",\n      \"request\":{\n         \"type\":\"ON_CLICK_SEND_INPUT\",\n         \"apiEndPoint\":{\n            \"apiUrl\":\"https://staging.cloud-elements.com/elements/api-v2/mapping/proceed\",\n            \"type\":\"GET\",\n            \"headers\":{\n               \"Elements-Formula-Instance-Id\":formula.activeCampaignMappingProceedSetup.instance\n            },\n            \"input\":{\n               \"apiKey\":steps.InputParams.input.apiKey,\n               \"siteName\" :steps.InputParams.input.siteName,\n               \"type\":steps.InputParams.input.type,\n               \"siteDomain\":steps.InputParams.input.siteDomain\n            }\n         }\n      }\n    }\n  }\n    }//else end\n\ndone({\n  statusCode: 200,\n  result: card\n})"}}],"triggers":[{"id":25945,"onSuccess":["InputParams"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"subFormulas":[{"id":31257,"name":"ChargebeeGet","userId":27893,"accountId":24428,"createdDate":"2019-11-12T11:30:28Z","steps":[{"id":245638,"onSuccess":["ChargebeeGetCBDelay2"],"onFailure":["ChargebeeGetResult"],"name":"ChargebeeGetCallAgainCB","type":"filter","properties":{"body":"//done(false); //Since delay causing 30 second limit issues\n\n\nif(steps.ChargebeeGetInputParams.intervel.length > 0 && steps.ChargebeeGetInputParams.retryCode[steps.ChargebeeGetGetCBData.response.code] !== undefined) {\n  steps.ChargebeeGetInputParams.delay.query.delay = steps.ChargebeeGetInputParams.intervel.pop();\n  done(true);\n}else {\n  done(false);\n}\n"}},{"id":245636,"onSuccess":["ChargebeeGetCBDelay"],"onFailure":["ChargebeeGetResult2"],"name":"ChargebeeGetCallAgainHttp","type":"filter","properties":{"body":"done(false); //Since delay causing 30 second limit issues\n\nif(steps.ChargebeeGetInputParams.intervel.length > 0 && steps.ChargebeeGetInputParams.retryCode[steps.ChargebeeGetGetHttpData.response.code] !== undefined) {\n  steps.ChargebeeGetInputParams.delay.query.delay = steps.ChargebeeGetInputParams.intervel.pop();\n  done(true);\n}else {\n  done(false);\n}\n"}},{"id":245637,"onSuccess":["ChargebeeGetGetHttpData"],"onFailure":[],"name":"ChargebeeGetCBDelay","type":"httpRequest","properties":{"method":"GET","url":"${steps.ChargebeeGetInputParams.delay.url}","headers":"${steps.ChargebeeGetInputParams.delay.headers}","query":"${steps.ChargebeeGetInputParams.delay.query}"}},{"id":245639,"onSuccess":["ChargebeeGetGetCBData"],"onFailure":[],"name":"ChargebeeGetCBDelay2","type":"httpRequest","properties":{"method":"GET","url":"${steps.ChargebeeGetInputParams.delay.url}","headers":"${steps.ChargebeeGetInputParams.delay.headers}","query":"${steps.ChargebeeGetInputParams.delay.query}"}},{"id":244768,"onSuccess":[],"onFailure":[],"name":"ChargebeeGetError","type":"script","properties":{"body":"done({\n  cb_status:\"failure\",\n  cb_error_code:\"formula_invalid_url\"\n});"}},{"id":244769,"onSuccess":["ChargebeeGetCallAgainCB"],"onFailure":["ChargebeeGetCallAgainCB"],"name":"ChargebeeGetGetCBData","type":"elementRequest","properties":{"method":"GET","headers":"${steps.ChargebeeGetInputParams.headers}","acceptableStatusCodes":"200-600","body":"","elementInstanceId":"${config.chargebee}","api":"${steps.ChargebeeGetInputParams.url}","query":"${steps.ChargebeeGetInputParams.query}"}},{"id":244774,"onSuccess":["ChargebeeGetCallAgainHttp"],"onFailure":["ChargebeeGetCallAgainHttp"],"name":"ChargebeeGetGetHttpData","type":"httpRequest","properties":{"method":"GET","url":"${steps.ChargebeeGetInputParams.url}","headers":"${steps.ChargebeeGetInputParams.headers}","acceptableStatusCodes":"200-600","body":"","query":"${steps.ChargebeeGetInputParams.query}"}},{"id":244764,"onSuccess":["ChargebeeGetIsValidUrl"],"onFailure":[],"name":"ChargebeeGetInputParams","type":"script","properties":{"body":"let url = trigger.args.url;\nlet query = trigger.args.query;\nlet apiKey = trigger.args.apiKey;\nlet headers = trigger.args.headers;\nlet siteDomain = trigger.args.siteDomain;\nlet siteName = trigger.args.siteName;\nlet type = trigger.args.type;\n\n\nlet intervel = [];\nintervel.push(5000);\nintervel.push(4000);\nintervel.push(3000);\nintervel.push(2000);\nintervel.push(1000);\n\nif (query === undefined) {\n    query = {};\n}\nif (headers === undefined) {\n    headers = {};\n}\ndone({\n    url: url,\n    query: query,\n    //intervel:[5000,10000,20000,40000,80000],\n    intervel: intervel,\n    retryCode: {\n        503: true,\n        429: true,\n        502: true,\n        403: true,\n        400: true,\n    },\n    hardStop: {\n        503: true,\n        429: true,\n        502: true,\n        403: true,\n        400: true,\n        500:true,\n        401:true\n    },\n    headers: headers,\n    delay: {\n        url: \"https://\" + siteName + \".integrations.\" + siteDomain + \"/api/ipaasdelay\",\n        query: {\n            delay: 2000\n        },\n        headers: {\n            \"api_key\": apiKey\n        }\n    }\n});"}},{"id":244771,"onSuccess":["ChargebeeGetGetHttpData"],"onFailure":["ChargebeeGetGetCBData"],"name":"ChargebeeGetIsHttp","type":"filter","properties":{"body":"done(steps.ChargebeeGetInputParams.url.startsWith(\"https://\"));"}},{"id":244767,"onSuccess":["ChargebeeGetIsHttp"],"onFailure":["ChargebeeGetError"],"name":"ChargebeeGetIsValidUrl","type":"filter","properties":{"body":"done(steps.ChargebeeGetInputParams.url !== undefined && steps.ChargebeeGetInputParams.url!== \"\");"}},{"id":244770,"onSuccess":[],"onFailure":[],"name":"ChargebeeGetResult","type":"script","properties":{"body":"if(steps.ChargebeeGetGetCBData.response.code < 300) {\n  done({\n    cb_status:\"success\",\n    cb_code: steps.ChargebeeGetGetCBData.response.code,\n    data:steps.ChargebeeGetGetCBData.response.body\n  });\n}else {\n  let cb_error_code = \"formula_default_error\";\n\n  let hardstop = steps.ChargebeeGetInputParams.hardStop[steps.ChargebeeGetGetCBData.response.code] !== undefined;\n  if(steps.ChargebeeGetGetCBData.response!== undefined && steps.ChargebeeGetGetCBData.response.body!== undefined && steps.ChargebeeGetGetCBData.response.body.error_code !== undefined) {\n    cb_error_code = steps.ChargebeeGetGetCBData.response.body.error_code;\n    let cbcode = steps.ChargebeeGetGetCBData.response.code || 404;\n  }\n  done({\n    cb_status:\"failure\",\n    cb_error_code:cb_error_code,\n    cb_code: cbcode,\n    cb_exit:hardstop\n  });\n}\n\n"}},{"id":244775,"onSuccess":[],"onFailure":[],"name":"ChargebeeGetResult2","type":"script","properties":{"body":"if(steps.ChargebeeGetGetHttpData.response.code <300) {\n  done({\n    cb_status:\"success\",\n    cb_code: steps.ChargebeeGetGetHttpData.response.code,\n    data:steps.ChargebeeGetGetHttpData.response.body\n  });\n}else {\n  let cb_error_code = \"formula_default_error\";\n\n  let hardstop = steps.ChargebeeGetInputParams.hardStop[steps.ChargebeeGetGetHttpData.response.code] !== undefined;\n  if(steps.ChargebeeGetGetHttpData.response.body!== undefined && steps.ChargebeeGetGetHttpData.response.body.error_code !== undefined) {\n    cb_error_code = steps.ChargebeeGetGetHttpData.response.body.error_code;\n  }\n  done({\n    cb_status:\"failure\",\n    cb_error_code:cb_error_code,\n    cb_exit:hardstop,\n    cb_code: steps.ChargebeeGetGetHttpData.response.code\n  });\n}\n\n"}}],"triggers":[{"id":27722,"onSuccess":["ChargebeeGetInputParams"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"engine":"v3","active":true,"debugLoggingEnabled":false,"singleThreaded":false,"configuration":[{"id":59935,"key":"chargebee","name":"chargebee","type":"elementInstance","required":true}]}],"method":"GET","uri":"/mapping","engine":"v1","active":true,"debugLoggingEnabled":true,"singleThreaded":false,"api":"GET /mapping","configuration":[]}