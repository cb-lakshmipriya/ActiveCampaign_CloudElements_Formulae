{"id":29326,"name":"testing-UnlinkActiveCampaign","userId":9541,"accountId":8529,"createdDate":"2019-09-03T08:28:37Z","steps":[{"id":214395,"onSuccess":["deleteThirdPartyElementInstance"],"onFailure":["updateParams"],"name":"allFormulaInstancesDeleted","type":"filter","properties":{"body":"if(steps.updateErrorLog_2 !== undefined){\n  if(steps.updateErrorLog_2.errorLog.length === 0){\n    done(true);\n  }else{\n    done(false);  \n  }\n}\n\ndone(true);"}},{"id":214396,"onSuccess":["ConfigParams"],"onFailure":[],"name":"ChargebeeConfigParams","type":"httpRequest","properties":{"headers":"${steps.InputParams.input.config.auth}","query":"${steps.InputParams.input.config.query}","method":"GET","url":"${steps.InputParams.input.config.url}"}},{"id":214397,"onSuccess":["loopOverFormulaConfigurations"],"onFailure":[],"name":"ConfigParams","type":"script","properties":{"body":"let config_param = {\n  configJSON :steps.ChargebeeConfigParams.response.body.third_party_configuration.config_json\n};\n\nconfig_param.deleteArray = [];\n\nconfig_param.deleteArray.push(config_param.configJSON.cloudElements.formula.mappingProceed);\nconfig_param.deleteArray.push(config_param.configJSON.cloudElements.formula.mapping);\nconfig_param.deleteArray.push(config_param.configJSON.cloudElements.formula.sync);\nconfig_param.deleteArray.push(config_param.configJSON.cloudElements.formula.validate);\n\ndone(config_param)\n"}},{"id":214398,"onSuccess":["DeleteFormulaInstance"],"onFailure":[],"name":"deleteConfig","type":"script","properties":{"body":"let formulaId = steps.loopOverFormulaConfigurations.entry.id;\nlet instanceId = steps.loopOverFormulaConfigurations.entry.instance;\n\nlet params = {\n  formula: formulaId,\n  instance: instanceId\n}\n\ndone(params)"}},{"id":214399,"onSuccess":["isDeleteFormulaSuccess"],"onFailure":["isDeleteFormulaSuccess"],"name":"DeleteFormulaInstance","type":"request","properties":{"retryDelay":"200","method":"DELETE","api":"/formulas/${steps.deleteConfig.formula}/instances/${steps.deleteConfig.instance}","retryAttempts":"5"}},{"id":214400,"onSuccess":["isDeleteThirdPartyInstanceSuccess"],"onFailure":["isDeleteThirdPartyInstanceSuccess"],"name":"deleteThirdPartyElementInstance","type":"request","properties":{"retryDelay":"200","method":"DELETE","api":"/instances/${steps.ConfigParams.configJSON.cloudElements.thirdParty.instance}","retryAttempts":"5"}},{"id":214401,"onSuccess":["deleteConfig"],"onFailure":["loopOverFormulaConfigurations"],"name":"hasFormulaID","type":"filter","properties":{"body":"if(steps.loopOverFormulaConfigurations.entry.id !== undefined){\n  done(true);\n}\ndone(false);"}},{"id":214402,"onSuccess":["retrieveLatestSyncDetails"],"onFailure":[],"name":"InputParams","type":"script","properties":{"body":"let apiKey = trigger.args.request.query['cb-api-key'];\nlet siteName = trigger.args.request.query['cb-site-name'];\nlet type = trigger.args.request.query['type'];\nlet siteDomain = trigger.args.request.query['cb-domain'];\nlet password = \"\";\nlet params = {\n  input: {\n    apiKey: apiKey,\n    siteName: siteName,\n    siteDomain:siteDomain,\n    type: type,\n    config :{\n      url: \"https://\"+siteName+\".\"+siteDomain+\"/api/v2/third_party_configurations\",\n      auth:{\n        Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password)\n      },\n      query:{\n        integration_name: type\n      }\n     \n    },\n    retrieveLatestSyncConfig : {\n      url:\"https://\"+siteName+\".\"+siteDomain+\"/api/v2/third_party_sync_details/retrieve_latest_sync\",\n      auth:{\n        Authorization: \"Basic \" + CE.b64(apiKey + \":\" + password)\n      },\n      query:{\n        'third_party_configuration[integration_name]': type\n      }\n    }\n  }\n};\n\n\n\ndone(params);"}},{"id":214403,"onSuccess":["updateSuccessLog_2"],"onFailure":["updateErrorLog_2"],"name":"isDeleteFormulaSuccess","type":"filter","properties":{"body":"if(steps.DeleteFormulaInstance.response.code !== 200){\n  done(false)\n}\n\ndone(true)"}},{"id":214404,"onSuccess":["updateSuccessLog_1"],"onFailure":["updateErrorLog_1"],"name":"isDeleteThirdPartyInstanceSuccess","type":"filter","properties":{"body":"if(steps.deleteThirdPartyElementInstance.response.code !== 200){\n  done(false);\n}\ndone(true);"}},{"id":214405,"onSuccess":["ChargebeeConfigParams"],"onFailure":["messageSyncRunning"],"name":"isSyncRunning","type":"filter","properties":{"body":"if((steps.retrieveLatestSyncDetails.response.code !== 200) || (steps.retrieveLatestSyncDetails.response.body.third_party_sync_detail === undefined)){\n  done(false);\n}\n\nif((steps.retrieveLatestSyncDetails.response.body.third_party_sync_detail.status === \"running\") || (steps.retrieveLatestSyncDetails.response.body.third_party_sync_detail.status === \"started\")){\n  done(false);\n}\n\n\ndone(true);"}},{"id":214406,"onSuccess":["hasFormulaID"],"onFailure":["allFormulaInstancesDeleted"],"name":"loopOverFormulaConfigurations","type":"loop","properties":{"list":"${steps.ConfigParams.deleteArray}"}},{"id":214407,"onSuccess":[],"onFailure":[],"name":"messageSyncRunning","type":"script","properties":{"body":"// let card = {\n//     \"cards\": [{\n//       \"id\": \"proceed\",\n//       \"display\": \"Sync All Records\",\n//       \"icon\": \"ARROW\",\n//       \"type\": \"POP_UP\",\n//       \"popUp\": {\n//           \"type\": \"SIMPLE\",\n//           \"title\": \"Sync in Progress\",\n//           \"usecase\":\"DANGER\",\n//           \"cancelButton\": \"Dismiss\",\n//           \"description\": \"Sync in Progress\"\n//       }\n//     }]\n// };\n\nlet card = {\n \"notice\" : \"Cannot Unlink, sync in progress\"\n};\n\ndone({\n  statusCode: 200,\n  result: card\n});"}},{"id":214408,"onSuccess":["isSyncRunning"],"onFailure":[],"name":"retrieveLatestSyncDetails","type":"httpRequest","properties":{"headers":"${steps.InputParams.input.retrieveLatestSyncConfig.auth}","query":"${steps.InputParams.input.retrieveLatestSyncConfig.query}","retryDelay":"200","method":"GET","url":"${steps.InputParams.input.retrieveLatestSyncConfig.url}","retry":"true","retryAttempts":"5"}},{"id":214409,"onSuccess":[],"onFailure":[],"name":"success","type":"script","properties":{"body":"let resultJS = {};\n\nresultJS.message = \"Integration Unlinked Successfully.\"\n\nlet errorLog1 = steps.updateErrorLog_1 ? steps.updateErrorLog_1.errorLog : [];\nlet errorLog2 = steps.updateErrorLog_2 ? steps.updateErrorLog_2.errorLog : [];\n\nlet successLog1 = steps.updateSuccessLog_1 ? steps.updateSuccessLog_1.successLog : [];\nlet successLog2 = steps.updateSuccessLog_2 ? steps.updateSuccessLog_2.successLog : [];\n\nlet errorLog = errorLog1.concat(errorLog2);\nlet successLog = successLog1.concat(successLog2);\n\nresultJS.successLog = (successLog.length > 0) ? successLog : [];\n\n// if(steps.updateConfigJSON.response !== undefined){\n//   if(steps.updateConfigJSON.response.code !== 200){\n//     errorLog.push(\"Unlinking Integration Failed : Failed to update Config JSON in Chargebee Third Party Configurations\");\n//   }\n// }\n\n// if(errorLog.length > 0){\n//   resultJS.message = \"Unlinking Integration Failed : Failed to Delete The Following Instances\";\n//   resultJS.errorLog = errorLog;\n// }\n\ndone({statusCode : 200});"}},{"id":214410,"onSuccess":["updateParams"],"onFailure":[],"name":"updateErrorLog_1","type":"script","properties":{"body":"let errorLog = [];\n\n\nif(steps.updateErrorLog_1 !== undefined){\n  errorLog = steps.updateErrorLog_1.errorLog;\n}\n\nerrorLog.push(\"Failed to Delete The Third Party Instance with ID: \"+ steps.ConfigParams.configJSON.cloudElements.thirdParty.instance + \"\\n\")\n\n\ndone({errorLog: errorLog});"}},{"id":214411,"onSuccess":["loopOverFormulaConfigurations"],"onFailure":[],"name":"updateErrorLog_2","type":"script","properties":{"body":"let errorLog = [];\n\nif(steps.updateErrorLog_2 !== undefined){\n  errorLog = steps.updateErrorLog_2.errorLog;\n}\n\nerrorLog.push(\"\\nFailed to Delete The Formula Instance\\n Formula ID: \"+ steps.deleteConfig.formula + \"\\nInstance ID: \" + steps.deleteConfig.instance + \"\\n\");\n\ndone({errorLog:errorLog});\n"}},{"id":214412,"onSuccess":["success"],"onFailure":[],"name":"updateParams","type":"script","properties":{"body":"let errorLog1 = steps.updateErrorLog_1 ? steps.updateErrorLog_1.errorLog : [];\nlet errorLog2 = steps.updateErrorLog_2 ? steps.updateErrorLog_2.errorLog : [];\n\nlet successLog1 = steps.updateSuccessLog_1 ? steps.updateSuccessLog_1.successLog : [];\nlet successLog2 = steps.updateSuccessLog_2 ? steps.updateSuccessLog_2.successLog : [];\n\nlet errorLog = errorLog1.concat(errorLog2);\nlet successLog = successLog1.concat(successLog2);\n\n\nlet configJson = {\n  cloudElements: {\n    success : successLog,\n    failed : errorLog,\n    chargebee : steps.ConfigParams.configJSON.cloudElements.chargebee\n  }\n}\n\nlet configParam = {\"new_sub_step\": \"\"};\n\n\nlet input = {\n  update: {\n    integration_name: trigger.args.request.query.type,\n    \"config_json\": \"{}\"\n  }\n};\n\n\ndone(input);"}},{"id":214413,"onSuccess":["updateParams"],"onFailure":[],"name":"updateSuccessLog_1","type":"script","properties":{"body":"let successLog = [];\n\n\nif(steps.updateSuccessLog_1 !== undefined){\n  successLog = steps.updateSuccessLog_1.successLog;\n}\n\nsuccessLog.push(\"Successfully deleted the Third Party Instance with ID: \"+ steps.ConfigParams.configJSON.cloudElements.thirdParty.instance + \"\\n\")\n\n\ndone({successLog: successLog});"}},{"id":214414,"onSuccess":["loopOverFormulaConfigurations"],"onFailure":[],"name":"updateSuccessLog_2","type":"script","properties":{"body":"let successLog = [];\n\nif(steps.updateSuccessLog_2 !== undefined){\n  successLog = steps.updateSuccessLog_2.successLog;\n}\n\nsuccessLog.push(\"\\nSuccessfully deleted the Formula Instance\\n Formula ID: \"+ steps.deleteConfig.formula + \"\\nInstance ID: \" + steps.deleteConfig.instance + \"\\n\");\n\ndone({successLog:successLog});\n"}}],"triggers":[{"id":25961,"onSuccess":["InputParams"],"onFailure":[],"type":"manual","async":true,"name":"trigger","properties":{}}],"method":"GET","uri":"/unlink","engine":"v1","active":true,"debugLoggingEnabled":true,"singleThreaded":false,"api":"GET /unlink","configuration":[]}